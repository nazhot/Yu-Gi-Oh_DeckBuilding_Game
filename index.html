<!DOCTYPE html>
<html>
  <head>
    <title>Yu-Gi-Oh DeckBuilder</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/public/css/style.css" />
  </head>
  <body>
    <div id="loading-screen">
      <div id="player1-side" class="side1">
        <p style="display: inline-block">Player One:</p>
        <p id="player1-connection" style="display: inline-block">NOT READY</p>
        <button id="start-game-button" style="display: none">START GAME</button>
      </div>
      <div id="player2-side" class="side2">
        <p style="display: inline-block">Player Two:</p>
        <p id="player2-connection" style="display: inline-block">NOT READY</p>
      </div>
    </div>
    <div id="playing-screen" style="display: none">
      <div id="player1-play-side" class="side1">

      </div>
      <div id="card-and-powerups">
        <img src="/public/images/back.png" id="middle-card" />
      </div>
      <div id="player2-play-side" class="side2">
 
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket     = io();
      let isPlayer1  = false;
      let isPlayer2  = false;
      let isViewer   = false;
      let bothReady  = false;
      let numRerolls = 5;
      let listNames  = ["card", "ban", "set"]; //names used to get all dropdown information
      let dropDowns  = {}; //holder for the three drop down elements, since they're so similar in name

      let imageApiPath = "https://storage.googleapis.com/ygoprodeck.com/pics/"
      let cardWidth    = "12.5%";
      let cards        = []; //holds own image objects for player 1/2, and all image objects for viewer
                             //this seems ineffecient, and may not work as abilities are added, we'll see
                             //server can't directly affect components FYI

      let startButton = document.getElementById("start-game-button");

      let myReadyButton;
      let myDrawButton;
      let myRerollButton;

      //setup the dropDowns object with the dropdown elements
      for (let i = 0; i < listNames.length; i++) {
        dropDowns[listNames[i]] = document.getElementById(
          listNames[i] + "-list-select"
        );
      }

      function makeMyComponents(player){
        //player: String, "player1" or "player2"
        //this is used to generate the buttons/textboxs/dropdowns for each player
        //ended up changing to js-generated HTML components due to the repetitive HTML
        //any change being made to a component required changing it in 2+ places, here it can be one place
        //this strategy won't be best for components that aren't symmetrical, but that's currently no componenets

        let myReadySide = document.getElementById(player + "-side");

        myReadyButton               = document.createElement("button");
        myReadyButton.id            = player + "-ready-button";
        myReadyButton.className     = "ready-button";
        myReadyButton.style.display = "block";
        myReadyButton.innerHTML     = "NOT READY";
        myReadyButton.addEventListener("click", () => {
          readyButtonClicked(player);
        });
        
        myReadySide.children[1].insertAdjacentElement("afterEnd", myReadyButton);
        
        if (player === "player1"){
          for (let i = 0; i < listNames.length; i++) {
            let listName        = listNames[i]; //card, ban, set
            let capitalListName = listName.charAt(0).toUpperCase() + listName.slice(1);

            let listLabel = document.createElement("label");

            listLabel.htmlFor       = listName + "-list-select";
            listLabel.id            = listName + "-list-label";
            listLabel.style.display = "flex";
            listLabel.innerHTML     = capitalListName + " List";

            let list = document.createElement("select");

            list.name          = listName + "-list-select";
            list.id            = listName + "-list-select";
            list.style.display = "flex";

            myReadySide.appendChild(listLabel);
            myReadySide.appendChild(list);
            dropDowns[listName] = list;
          }
          socket.emit("getLists");
        }

        let myPlaySide = document.getElementById(player + "-play-side");

        myDrawButton               = document.createElement("button");
        myDrawButton.id            = player + "-draw-card";
        myDrawButton.className     = "draw-card-button";
        myDrawButton.style.display = "none";
        myDrawButton.innerHTML     = "Draw Card";
        myDrawButton.addEventListener("click", () => {
          let lastCard = cards.length > 0 ? cards[cards.length - 1] : null;
          socket.emit("draw-card", isPlayer1, lastCard);
          myDrawButton.style.display   = "none";
          myRerollButton.style.display = "none";
        });

        myRerollButton               = document.createElement("button");
        myRerollButton.id            = player + "-reroll-button";
        myRerollButton.className     = "reroll-card-button";
        myRerollButton.style.display = "none";
        myRerollButton.innerHTML     = "Re-Roll (" + numRerolls + ")";
        myRerollButton.addEventListener("click", () => {
          //number of rerolls left is checked here to avoid any issues server side, since it can't readily check, it'd have to be told
          //numRerolls is decremented when socket recieves the reroll message
          if (numRerolls > 0) {
            socket.emit("reroll", isPlayer1, cards[cards.length - 1].alt);
          }
        });

        myPlaySide.appendChild(myDrawButton);
        myPlaySide.appendChild(myRerollButton);
      }

      function checkIfBothReady() {
        let player1 = document.getElementById("player1-connection").innerHTML;
        let player2 = document.getElementById("player2-connection").innerHTML;
        return player1 === "READY" && player2 === "READY";
      }

      function readyButtonClicked(player) {
        //player: "player1" or "player2"
        if (myReadyButton.innerHTML === "READY") {
          myReadyButton.innerHTML             = "NOT READY";
          myReadyButton.style.backgroundColor = "darkred";
        } else {
          myReadyButton.innerHTML             = "READY";
          myReadyButton.style.backgroundColor = "darkgreen";
        }
        //send out message so that other player/viewer can see your current status
        socket.emit("ready-change", player, myReadyButton.innerHTML);
      }

      function setDrawnCard(playerSide, drawCard, samePlayer, cardId) {
        //playerSide: dom element, div that correlates with the users side
        //drawCard:   String,      path to the card image to display
        //samePlayer: boolean,     if the player calling this function is the same one that had drawn the card
        //cardId:     String,      the id of the card, to be stored in the alt of the image, for updating counts on server side if rerolled
        let newCard = document.createElement("img");
        newCard.src = drawCard;
        newCard.alt = cardId;
        newCard.style.width = cardWidth;
        //when moused over, show the image in the middle card
        //when not moused over, default to card back
        newCard.onmouseover = () => {
          let middleCard = document.getElementById("middle-card");
          middleCard.src = newCard.src;
        };
        newCard.onmouseleave = () => {
          let middleCard = document.getElementById("middle-card");
          middleCard.src = "/public/images/back.png";
        };
        if (samePlayer) {
          cards.push(newCard);
        }
        playerSide.appendChild(newCard);
      }

      startButton.addEventListener("click", () => {
        socket.emit("start-game", dropDowns.card.value, dropDowns.ban.value, dropDowns.set.value);
        myDrawButton.style.display   = "flex";
        myRerollButton.style.display = "flex";
      });




      socket.on("player1", (id) => {
        //only player receiving this message is player 1, since the trigger to send it is 1 person connected
        //no need to check for anything to run this
        isPlayer1 = true;
        makeMyComponents("player1");
      });

      socket.on("player2", (id) => {
        //if message is received by player 2, set their buttons
        //if message is received by player 1, let player 2 know your ready status 
        //viewer won't receieve this, message is sent out when 2 people are connected
        isPlayer2 = socket.id === id;
        if (isPlayer2) {
          makeMyComponents("player2");
        } else {
          socket.emit("ready-change", "player1", myReadyButton.innerHTML);
        }
      });

      socket.on("viewer", (id) => {
        isViewer = id === socket.id;
        if (isPlayer1 || isPlayer2) {
          //sends current "READY" status of the players to the viewer
          socket.emit("ready-change", isPlayer1 ? "player1" : "player2", myReadyButton.innerHTML);
        }
      });

      socket.on("ready-change", (player, readyText) => {
        //player:    String, "player1" or "player2", whoever clicked their ready button
        //readyText: String, "READY" or "NOT READY", whatever the button's text value now is
        let readyTextComponent = document.getElementById(player + "-connection");
        readyTextComponent.innerHTML = readyText;
        //if client is player1, additional check has to be done to see if both players are ready and start button should be shown
        if (isPlayer1) {
          bothReady = checkIfBothReady();
          if (bothReady) {
            startButton.style.display = "block";
          } else {
            startButton.style.display = "none";
          }
        }
      });

      socket.on("setLists", (cardLists, banLists, setLists) => {
        //all lists are arrays, pertaining to the names of the files for each one
        //used to set the drop down entries
        let lists = {
          card: cardLists,
          ban: banLists,
          set: setLists,
        };
        for (let i = 0; i < listNames.length; i++) {
          let listName = listNames[i]; //card, ban, set
          for (let j = 0; j < lists[listName].length; j++) {
            let list     = lists[listName];
            let newEntry = document.createElement("option");

            newEntry.value     = list[j];
            newEntry.innerHTML = list[j];

            let dropDown = document.getElementById(listName + "-list-select");
            dropDown.appendChild(newEntry);
          }
        }
      });

      socket.on("start-game", () => {
        //player 1 takes care of making the right buttons visible when they click the start button
        //no need to do so here, just change the screen
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("playing-screen").style.display = "inline-block";
      });

      socket.on("draw-card", (player1, drawCard) => {
        //player1:  boolean, whether the player that drew the card is player 1
        //drawCard: String,  cardID of the card that was randomly selected to be added to the deck
        let playerSide;
        let newCardPath;
        let samePlayer = isPlayer1 === player1;
        let cardId = drawCard;
        if (isViewer) {
          //samePlayer is set to true to ensure that viewer card list contains all cards
          newCardPath = imageApiPath + drawCard + ".jpg";
          playerSide  = document.getElementById((player1 ? "player1" : "player2") + "-play-side");
          samePlayer  = true;
        } else if (isPlayer1 === player1) {
          //player that drew a card
          //player sets their own buttons to be hidden, no need to do so here
          newCardPath = imageApiPath + drawCard + ".jpg";
          playerSide  = document.getElementById((isPlayer1 ? "player1" : "player2") + "-play-side");
        } else {
          //not the player that drew a card
          newCardPath = "/public/images/back.png";
          cardId = "-1";
          playerSide = document.getElementById((isPlayer1 ? "player2" : "player1") + "-play-side");
          myDrawButton.style.display   = "flex";
          myRerollButton.style.display = "flex";
        }
        setDrawnCard(playerSide, newCardPath, samePlayer, cardId);
      });

      socket.on("reroll", (newCardId, player1) => {
        if (cards.length === 0) return;
        if (cards.length < 2 && isViewer) return;
        if (isViewer || isPlayer1 === player1) {
          let subtraction = isViewer ? 2 : 1;
          cards[cards.length - subtraction].src =
            imageApiPath + newCardId + ".jpg";
          cards[cards.length - subtraction].alt = newCardId;
          numRerolls--;
          myRerollButton.innerHTML = "Re-Roll (" + numRerolls + ")";
        }
      });
    </script>
  </body>
</html>
