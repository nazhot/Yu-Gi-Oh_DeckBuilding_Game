<!DOCTYPE html>
<html>
  <head>
    <title>Yu-Gi-Oh DeckBuilder</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/public/css/style.css" />
    <script src="/cardFunctions.js"></script>
  </head>
  <body>
    <div id="loading-screen">
      <div id="player1-side" class="side1">
        <p style="display: inline-block">Player One:</p>
        <p id="player1-connection" style="display: inline-block">NOT READY</p>
        <button
          id="player1-ready-button"
          class="ready-button"
          style="display: none"
        >
          NOT READY
        </button>
        <button id="start-game-button" style="display: none">START GAME</button>
      </div>
      <div id="player2-side" class="side2">
        <p style="display: inline-block">Player Two:</p>
        <p id="player2-connection" style="display: inline-block">NOT READY</p>
        <button
          id="player2-ready-button"
          class="ready-button"
          style="display: none"
        >
          NOT READY
        </button>
      </div>
    </div>
    <div id="playing-screen" style="display: none">
      <div id="player1-play-side" class="side1">
        <button
          id="player1-draw-card"
          class="draw-card-button"
          style="display: none"
        >
          Draw Card
        </button>
        <button
          id="player1-reroll-card"
          class="reroll-card-button"
          style="display: none"
        >
          Re-Roll
        </button>
      </div>
      <div id="card-and-powerups">
        <img src="/public/images/back.png" id="middle-card" />
      </div>
      <div id="player2-play-side" class="side2">
        <button
          id="player2-draw-card"
          class="draw-card-button"
          style="display: none"
        >
          Draw Card
        </button>
        <button
          id="player2-reroll-card"
          class="reroll-card-button"
          style="display: none"
        >
          Re-Roll
        </button>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket = io();
      let isPlayer1 = false;
      let isPlayer2 = false;
      let isViewer = false;
      let bothReady = false;

      let imageApiPath = "https://images.ygoprodeck.com/images/cards/";
      let cardWidth = "12.5%";
      let cardIds;
      let cards = []; //holds own image objects for player 1/2, and all image objects for viewer
                      //this seems ineffecient, and may not work as abilities are added, we'll see

      let startButton = document.getElementById("start-game-button");

      let myReadyButton;
      let myDrawButton;
      let myRerollButton;

      function checkIfBothReady() {
        let player1 = document.getElementById("player1-connection").innerHTML;
        let player2 = document.getElementById("player2-connection").innerHTML;
        return player1 === "READY" && player2 === "READY";
      }

      function readyButtonClicked(player) {
        //player: "player1" or "player2"
        if (myReadyButton.innerHTML === "READY") {
          myReadyButton.innerHTML = "NOT READY";
          myReadyButton.style.backgroundColor = "darkred";
        } else {
          myReadyButton.innerHTML = "READY";
          myReadyButton.style.backgroundColor = "darkgreen";
        }
        socket.emit("ready-change", player, myReadyButton.innerHTML);
      }

      function setDrawnCard(playerSide, drawCard, samePlayer) {
        //playerSide: div that coretMouseOverrelates with the users side
        //drawCard: String, path to the image to display
        //samePlayer: if the player calling this function is the same one that had drawn the card
        let newCard = document.createElement("img");
        newCard.src = drawCard;
        newCard.style.width = cardWidth;
        newCard.onmouseover = () => {
          let middleCard = document.getElementById("middle-card");
          middleCard.src = newCard.src;
        };
        newCard.onmouseleave = () => {
          let middleCard = document.getElementById("middle-card");
          middleCard.src = "/public/images/back.png";
        };
        if (samePlayer) {
          cards.push(newCard);
        }
        playerSide.appendChild(newCard);
      }

      function setMyButtons(player) {
        //player: String, "player1" or "player2"
        myReadyButton = document.getElementById(player + "-ready-button");
        myReadyButton.style.display = "block";
        myReadyButton.addEventListener("click", () => {
          readyButtonClicked(player);
        });
        myDrawButton = document.getElementById(player + "-draw-card");
        myDrawButton.addEventListener("click", () => {
          socket.emit("draw-card", isPlayer1);
          myDrawButton.style.display = "none";
          myRerollButton.style.display = "none";
        });
        myRerollButton = document.getElementById(player + "-reroll-card");
        myRerollButton.addEventListener("click", () => {
          socket.emit("reroll", isPlayer1);
        });
      }

      startButton.addEventListener("click", () => {
        socket.emit("start-game");
        myDrawButton.style.display = "flex";
        myRerollButton.style.display = "flex";
      });

      socket.on("ready-change", (player, readyText) => {
        let readyTextComponent = document.getElementById(
          player + "-connection"
        );
        readyTextComponent.innerHTML = readyText;
        if (isPlayer1) {
          bothReady = checkIfBothReady();
          let startButton = document.getElementById("start-game-button");
          if (bothReady) {
            startButton.style.display = "block";
          } else {
            startButton.style.display = "none";
          }
        }
      });

      socket.on("player1", (id) => {
        console.log("received player 1 on client: " + id);
        isPlayer1 = true;
        setMyButtons("player1");
      });

      socket.on("player2", (id) => {
        isPlayer2 = socket.id === id;
        if (isPlayer2) {
          setMyButtons("player2");
        } else {
          socket.emit("ready-change", "player1", myReadyButton.innerHTML);
        }
      });

      socket.on("viewer", (id) => {
        isViewer = id === socket.id;
        if (isPlayer1 || isPlayer2) {
          //sends current "READY" status of the players to the viewer
          socket.emit(
            "ready-change",
            isPlayer1 ? "player1" : "player2",
            myReadyButton.innerHTML
          );
        }
      });

      socket.on("start-game", () => {
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("playing-screen").style.display =
          "inline-block";
      });

      socket.on("draw-card", (player1, drawCard) => {
        let playerSide;
        let newCardPath;
        let samePlayer = isPlayer1 === player1;
        if (isViewer) {
          newCardPath = imageApiPath + drawCard + ".jpg";
          playerSide = document.getElementById(
            (player1 ? "player1" : "player2") + "-play-side"
          );
          samePlayer = true;
        } else if (isPlayer1 === player1) {
          //player that drew a card
          newCardPath = imageApiPath + drawCard + ".jpg";
          playerSide = document.getElementById(
            (isPlayer1 ? "player1" : "player2") + "-play-side"
          );
        } else {
          //not the player that drew a card
          newCardPath = "/public/images/back.png";
          playerSide = document.getElementById(
            (isPlayer1 ? "player2" : "player1") + "-play-side"
          );
          myDrawButton.style.display = "flex";
          myRerollButton.style.display = "flex";
        }
        setDrawnCard(playerSide, newCardPath, samePlayer);
      });

      socket.on("reroll", (newCardId, player1) => {
        if (cards.length === 0) return;
        if (cards.length < 2 && isViewer) return;
        if (isViewer || isPlayer1 === player1) {
          let subtraction = isViewer ? 2 : 1;
          cards[cards.length - subtraction].src = imageApiPath + newCardId + ".jpg";
        }
      });
    </script>
  </body>
</html>
